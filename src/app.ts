#! /usr/bin/env node

import { exec } from 'child_process';
import { readdir, writeFile } from 'node:fs/promises';
import { exit } from 'process';
import { WRITE_PATH_DIR } from './constants/WRITE_PATH_DIR';
import askForFileName from './functions/askForFileName';
import checkForDuplicateName from './functions/checkForDuplicateName';
import generateFileName from './functions/generateFileName';
import generateTxtData from './functions/generateTxtData';

const main = async () => {
  console.log(`Welcome to txt_helper! `);
  let userIsSettingFileName = true;
  let fileName = '';
  let isFileNameAutoGenerated = false;

  const filesOnWriteDir = await readdir(WRITE_PATH_DIR);
  const txtFilesOnWriteDir = filesOnWriteDir.filter((fileName: string) => {
    return fileName.endsWith('.txt');
  });

  while (userIsSettingFileName) {
    const tempFileName = await askForFileName();

    if (tempFileName === '') {
      fileName = generateFileName();
      isFileNameAutoGenerated = true;
      userIsSettingFileName = false;

      break;
    } else {
      const hasDuplicateName = await checkForDuplicateName(
        txtFilesOnWriteDir,
        tempFileName
      );

      if (hasDuplicateName) {
        console.log('This file already exists! Please choose another name...');
      } else {
        fileName = tempFileName;
        userIsSettingFileName = false;

        break;
      }
    }
  }

  const relativePath = `${WRITE_PATH_DIR}/${fileName}.txt`;

  let txtData = generateTxtData(isFileNameAutoGenerated, fileName);

  await writeFile(relativePath, txtData);

  console.log(
    `${fileName}.txt created successfully on ${relativePath}! Opening it...`
  );

  const cmd = `open ${relativePath}`;

  exec(cmd, (error, stdout, stderr) => {
    if (error) {
      console.error(`exec error: ${error}`);
      return;
    }
    console.log(`stdout: ${stdout}`);
    console.error(`stderr: ${stderr}`);
  });

  exit();
};

main();
